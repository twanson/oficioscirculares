<%- include('partials/head-meta', { 
  title: 'Renovar acceso ‚Äî Directorio | Oficios Circulares',
  description: 'Renueva tu acceso al directorio de proveedores de Oficios Circulares.',
  canonical: '/renovar-acceso',
  noindex: true
}) %>
<%- include('partials/header') %>

<main class="main-content">
    <section class="renovar-acceso-section">
        <div class="container">
            <div class="renovar-content" style="max-width: 600px; margin: 0 auto; text-align: center; padding: 2rem 1rem;">
                <div class="access-icon" style="font-size: 4rem; margin-bottom: 1rem;">üîê</div>
                
                <h1 class="renovar-title" style="margin-bottom: 1rem;">Acceso requerido</h1>
                
                <% if (error) { %>
                    <div class="error-message" style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin: 1.5rem 0; color: #dc2626;">
                        <p style="margin: 0; font-weight: 500;">
                            <% if (error === 'Token not found') { %>
                                üîç <strong>Enlace no encontrado:</strong> El enlace que usaste no es v√°lido.
                            <% } else if (error === 'Token expired') { %>
                                ‚è∞ <strong>Enlace expirado:</strong> Tu enlace de acceso ha caducado.
                            <% } else if (error === 'Token revoked') { %>
                                üö´ <strong>Acceso revocado:</strong> Este enlace ha sido desactivado.
                            <% } else { %>
                                ‚ùå <strong>Error de acceso:</strong> <%= error.replace(/_/g, ' ') %>
                            <% } %>
                        </p>
                    </div>
                <% } %>
                
                <div class="renovar-message">
                    <p style="font-size: 1.1rem; color: #666; line-height: 1.6; margin-bottom: 2rem;">
                        Para acceder al <strong>Directorio de Proveedores</strong> necesitas un enlace v√°lido. 
                        Si tu enlace ha expirado, podemos enviarte un nuevo acceso.
                    </p>
                </div>

                <!-- Formulario de renovaci√≥n de acceso -->
                <div class="renewal-form-section" style="background: #f8f9fa; padding: 2rem; border-radius: 12px; margin: 2rem 0;">
                    <h3 style="margin: 0 0 1.5rem; text-align: center; color: #333;">Renovar tu acceso</h3>
                    
                    <form id="renewalForm" style="max-width: 400px; margin: 0 auto;">
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="email" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #555;">
                                Tu email de la comunidad:
                            </label>
                            <input 
                                type="email" 
                                id="email" 
                                name="email" 
                                required 
                                autocomplete="email"
                                placeholder="tu@email.com"
                                style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;"
                            />
                        </div>
                        
                        <button 
                            type="submit" 
                            id="submitBtn"
                            class="btn btn-primary" 
                            style="width: 100%; padding: 0.75rem; font-size: 1rem; margin-bottom: 1rem;"
                        >
                            Solicitar nuevo acceso
                        </button>
                    </form>

                    <div id="successMessage" style="display: none; background: #d1fae5; border: 1px solid #a7f3d0; border-radius: 6px; padding: 1rem; margin-top: 1rem; color: #047857;">
                        <p style="margin: 0; font-weight: 500;">
                            ‚úÖ Si tu email est√° en la comunidad, te hemos enviado un nuevo enlace v√°lido por 60 d√≠as. 
                            <br><small>Revisa tambi√©n tu carpeta de Spam.</small>
                        </p>
                    </div>
                </div>

                <div class="alternative-actions" style="margin: 2rem 0;">
                    <p style="color: #666; margin-bottom: 1rem; font-size: 0.95rem;">
                        <strong>Otras opciones:</strong>
                    </p>
                    <a href="/recursos" class="btn btn-secondary" style="margin-right: 1rem; margin-bottom: 0.5rem;">
                        Ver recursos
                    </a>
                    <a href="/" class="btn btn-outline" style="margin-bottom: 0.5rem;">
                        Ir al inicio
                    </a>
                </div>

                <div class="help-note" style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                    <p style="color: #888; font-size: 0.85rem; margin: 0;">
                        ¬øSigues teniendo problemas? Los enlaces tienen una validez de 60 d√≠as y se renuevan autom√°ticamente cuando accedes.
                    </p>
                </div>
            </div>
        </div>
    </section>
</main>

<%- include('partials/footer') %>

<script>
// Analytics tracking
window.dataLayer = window.dataLayer || [];
window.dataLayer.push({ 
    event: 'directorio_access_denied',
    error_type: '<%= error || "unknown" %>',
    page: '/renovar-acceso'
});

// Manejo del formulario de renovaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('renewalForm');
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');
    const emailInput = document.getElementById('email');

    // Verificar si hay cooldown guardado en localStorage
    function getCooldownExpiry(email) {
        const key = 'renewal_cooldown_' + email.toLowerCase();
        const expiry = localStorage.getItem(key);
        return expiry ? parseInt(expiry) : 0;
    }

    function setCooldown(email) {
        const key = 'renewal_cooldown_' + email.toLowerCase();
        const expiry = Date.now() + (10 * 60 * 1000); // 10 minutos
        localStorage.setItem(key, expiry.toString());
    }

    function isInCooldown(email) {
        const expiry = getCooldownExpiry(email);
        return Date.now() < expiry;
    }

    function getRemainingCooldown(email) {
        const expiry = getCooldownExpiry(email);
        const remaining = Math.max(0, expiry - Date.now());
        return Math.ceil(remaining / (60 * 1000)); // minutos restantes
    }

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = emailInput.value.trim().toLowerCase();
        
        if (!email) {
            alert('Por favor, introduce tu email.');
            return;
        }

        // Verificar cooldown local
        if (isInCooldown(email)) {
            const remaining = getRemainingCooldown(email);
            alert(`Ya se ha enviado una solicitud para este email. Espera ${remaining} minuto(s) antes de volver a intentarlo.`);
            return;
        }

        // Deshabilitar bot√≥n y mostrar loading
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';

        try {
            const response = await fetch('/api/renew-access', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email })
            });

            const result = await response.json();

            if (response.ok && result.ok) {
                // Mostrar mensaje de √©xito
                form.style.display = 'none';
                successMessage.style.display = 'block';
                
                // Activar cooldown local
                setCooldown(email);

                // Analytics
                window.dataLayer.push({
                    event: 'directorio_renewal_requested',
                    email_hash: btoa(email).substring(0, 8), // Hash parcial para analytics
                    page: '/renovar-acceso'
                });
            } else {
                throw new Error('Error en la solicitud');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Hubo un problema al procesar tu solicitud. Int√©ntalo m√°s tarde.');
        } finally {
            // Restaurar bot√≥n
            submitBtn.disabled = false;
            submitBtn.textContent = 'Solicitar nuevo acceso';
        }
    });
});
</script>
</body>
</html>