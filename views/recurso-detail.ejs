<%- include('partials/head-meta', { title, description, canonical }) %>
<%- include('partials/header') %>

<main class="main-content">
    <section class="recurso-detail-section">
        <div class="container">
            <div class="recurso-detail">
                <header class="recurso-header">
                    <h1 class="recurso-title"><%= recurso.title %></h1>
                    <p class="recurso-description"><%= recurso.summary %></p>
                </header>
                
                <div class="recurso-visual">
                    <img loading="lazy" src="<%= recurso.cover %>" alt="<%= recurso.title %>" class="recurso-cover">
                </div>

                <% if (recurso.slug === 'guia-materiales') { %>
                <!-- Contenido espec√≠fico para Gu√≠a de Materiales Completa -->
                <div class="recurso-content-detail">
                    <div class="content-section">
                        <h2>¬øQu√© es?</h2>
                        <p>Una gu√≠a pr√°ctica para elegir materiales con criterio sin tecnicismos. Re√∫ne en un solo lugar qu√© preferir y qu√© evitar por oficio, por qu√© hacerlo y c√≥mo aplicarlo en tu d√≠a a d√≠a.</p>
                    </div>

                    <div class="content-section">
                        <h2>¬øPara qui√©n?</h2>
                        <ul>
                            <li><strong>Artesanos y peque√±os talleres.</strong></li>
                            <li><strong>Marcas emergentes de producto f√≠sico</strong> (textil, cer√°mica, joyer√≠a, madera, papel/cart√≥n, velas/cosm√©tica, packaging, etc.).</li>
                            <li><strong>Dise√±adores y makers</strong> que buscan criterios claros y proveedores fiables.</li>
                        </ul>
                    </div>

                    <div class="content-section">
                        <h2>Qu√© incluye</h2>
                        <ul>
                            <li><strong>Criterios por oficio:</strong> qu√© preferir/evitar y la raz√≥n (impacto, durabilidad, fin de vida, viabilidad).</li>
                            <li><strong>Fichas de materiales</strong> con pros/contras y usos recomendados.</li>
                            <li><strong>Checklist de compra responsable</strong> para revisar en 2‚Äì3 minutos antes de pedir.</li>
                            <li><strong>Marco legal expr√©s</strong> para comunicar sin greenwashing.</li>
                            <li><strong>Errores habituales</strong> y c√≥mo evitarlos.</li>
                            <li><strong>Plantillas simples:</strong> matriz de decisi√≥n y trazabilidad m√≠nima.</li>
                            <li><strong>Acceso al Directorio vivo</strong> de proveedores verificados y recursos que actualizamos de forma continua.</li>
                        </ul>
                    </div>

                    <div class="content-section">
                        <h2>Qu√© te resuelve</h2>
                        <ul>
                            <li>Ahorras horas de b√∫squeda y pruebas fallidas.</li>
                            <li>Reduces residuos y retrabajos desde el dise√±o.</li>
                            <li>Tomas decisiones con criterio y puedes explicarlas a clientes y equipo.</li>
                            <li>Evitas riesgos por claims ambientales confusos.</li>
                        </ul>
                    </div>

                    <div class="content-section">
                        <h2>Formato y actualizaciones</h2>
                        <p>Descarga en PDF + acceso al Directorio vivo para que tus contactos y recursos no queden desactualizados.</p>
                    </div>
                </div>
                <% } else if (recurso.slug === 'circular-express') { %>
                <!-- Contenido espec√≠fico para Circular Express -->
                <div class="recurso-content-detail">
                    <div class="content-section">
                        <h2>¬øQu√© es?</h2>
                        <p>Un auto-diagn√≥stico breve para medir el nivel de circularidad de tu taller o marca y decidir d√≥nde actuar primero.</p>
                    </div>

                    <div class="content-section">
                        <h2>¬øPara qui√©n?</h2>
                        <ul>
                            <li><strong>Artesanos y peque√±os talleres.</strong></li>
                            <li><strong>Marcas emergentes de producto f√≠sico.</strong></li>
                            <li><strong>Cualquier proyecto</strong> que quiera una foto r√°pida de su situaci√≥n y un plan simple para mejorar.</li>
                        </ul>
                    </div>

                    <div class="content-section">
                        <h2>Qu√© incluye</h2>
                        <ul>
                            <li><strong>Checklist de pr√°cticas clave.</strong></li>
                            <li><strong>Puntuaci√≥n r√°pida por √°reas</strong> (materiales, residuos, dise√±o, operaciones, comunicaci√≥n).</li>
                            <li><strong>Mini-plan de mejora inmediata</strong> con 3‚Äì5 acciones priorizadas.</li>
                            <li><strong>Consejos pr√°cticos y atajos</strong> para empezar hoy.</li>
                        </ul>
                    </div>

                    <div class="content-section">
                        <h2>C√≥mo funciona (3 pasos)</h2>
                        <ol>
                            <li><strong>Descarga la gu√≠a.</strong></li>
                            <li><strong>Completa el checklist</strong> (10‚Äì15 min).</li>
                            <li><strong>Revisa tu puntuaci√≥n</strong> y aplica el mini-plan.</li>
                        </ol>
                    </div>

                    <div class="content-section">
                        <h2>Qu√© te llevas</h2>
                        <ul>
                            <li>Claridad sobre lo que ya haces bien.</li>
                            <li>Un orden de prioridades realista para las pr√≥ximas semanas.</li>
                            <li>Un lenguaje com√∫n para hablar con equipo y clientes.</li>
                        </ul>
                    </div>

                    <div class="content-section">
                        <h2>Formato y tiempo</h2>
                        <p>PDF breve y accionable. Se completa en 10‚Äì15 minutos.</p>
                    </div>
                </div>
                <% } %>

                <!-- FORMULARIO TALLY con par√°metros optimizados -->
                <section class="recurso-cta">
                    <div class="cta-container">
                        <h3>Completa el formulario para recibir el recurso</h3>
                        <p>Descarga inmediata despu√©s de completar los datos</p>

                        <!-- Constante base con par√°metros del servidor -->
                        <% const base = `https://tally.so/embed/${recurso.form_tally_id}?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1&resource_id=${recurso.slug}&source=web`; %>

                        <!-- Embed de Tally -->
                        <div id="tally-embed" class="tally-form-container" aria-live="polite">
                            <iframe data-tally-src="<%= base %>" loading="lazy" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0" title="<%= recurso.title %>"></iframe>
                        </div>
                        <script defer>
                            (function(){
                                var s=document.createElement('script');
                                s.src='https://tally.so/widgets/embed.js';
                                s.onload=function(){ 
                                    if(window.Tally) {
                                        Tally.loadEmbeds();
                                        
                                        // Script optimizado: solo page_url, UTMs se heredan autom√°ticamente
                                        window.addEventListener('message', function(e) {
                                            if (e.data.type === 'tally-form-submitted') {
                                                const url = new URL(window.location.href);
                                                const params = new URLSearchParams();
                                                params.set('page_url', url.href);
                                                // UTMs se heredan de window.location.search tal cual
                                                
                                                // Redirigir a la p√°gina de gracias
                                                window.location.href = `/gracias/${recurso.slug}?${params.toString()}`;
                                            }
                                        });
                                    }
                                };
                                document.body.appendChild(s);
                            })();
                        </script>

                        <!-- Informaci√≥n adicional -->
                        <div class="form-info">
                            <p><small>üîí Tus datos est√°n seguros. Solo los usamos para enviarte el recurso y contenido relacionado ocasionalmente.</small></p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </section>
</main>

<%- include('partials/footer') %>

<script src="/assets/js/script.js"></script>
</body>
</html>
