<%- include('partials/head-meta', { title, description, canonical }) %>
<%- include('partials/header') %>

<main class="main-content">
    <section class="recurso-detail-section">
        <div class="container">
            <div class="recurso-detail">
                <header class="recurso-header">
                    <h1 class="recurso-title"><%= recurso.title %></h1>
                    <p class="recurso-description"><%= recurso.summary %></p>
                </header>
                
                <div class="recurso-visual">
                    <img loading="lazy" src="<%= recurso.cover %>" alt="<%= recurso.title %>" class="recurso-cover">
                </div>

                <!-- FORMULARIO TALLY con parámetros optimizados -->
                <section class="recurso-cta">
                    <div class="cta-container">
                        <h3>Completa el formulario para recibir el recurso</h3>
                        <p>Descarga inmediata después de completar los datos</p>

                        <!-- Constante base con parámetros del servidor -->
                        <% const base = `https://tally.so/embed/${recurso.form_tally_id}?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1&resource_id=${recurso.slug}&source=web`; %>

                        <!-- Embed de Tally -->
                        <div id="tally-embed" class="tally-form-container" aria-live="polite">
                            <iframe data-tally-src="<%= base %>" loading="lazy" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0" title="<%= recurso.title %>"></iframe>
                        </div>
                        <script defer>
                            (function(){
                                var s=document.createElement('script');
                                s.src='https://tally.so/widgets/embed.js';
                                s.onload=function(){ 
                                    if(window.Tally) {
                                        Tally.loadEmbeds();
                                        
                                        // Script optimizado: solo page_url, UTMs se heredan automáticamente
                                        window.addEventListener('message', function(e) {
                                            if (e.data.type === 'tally-form-submitted') {
                                                const url = new URL(window.location.href);
                                                const params = new URLSearchParams();
                                                params.set('page_url', url.href);
                                                // UTMs se heredan de window.location.search tal cual
                                                
                                                // Redirigir a la página de gracias
                                                window.location.href = `/gracias/${recurso.slug}?${params.toString()}`;
                                            }
                                        });
                                    }
                                };
                                document.body.appendChild(s);
                            })();
                        </script>

                        <!-- Información adicional -->
                        <div class="form-info">
                            <p><small>🔒 Tus datos están seguros. Solo los usamos para enviarte el recurso y contenido relacionado ocasionalmente.</small></p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </section>
</main>

<%- include('partials/footer') %>

<script src="/assets/js/script.js"></script>
</body>
</html>
