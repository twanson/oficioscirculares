<%-
  include('partials/head-meta', {
    title: 'Directorio de Proveedores ‚Äî Solo miembros | Oficios Circulares',
    description: 'Accede gratis al directorio vivo de proveedores (materiales, m√≠nimos, plazos y m√°s). Enlace por email, sin contrase√±as.',
    canonical: '/dir',
    noindex: typeof noindex !== 'undefined' ? noindex : false
  })
%>
<%- include('partials/header') %>

<main class="main-content">
    <section class="recurso-detail-section">
        <div class="container">
            <div class="recurso-detail">
                <!-- Gate: se muestra si NO hay cookie o token v√°lido -->
                <div id="gate" style="display:none;">
                    <header class="recurso-header">
                        <h1 class="recurso-title">Directorio de Proveedores</h1>
                        <p class="recurso-description">Accede gratis al directorio vivo de proveedores, con materiales, m√≠nimos, plazos y m√°s. Solo para miembros de Oficios Circulares.</p>
                    </header>

                    <section class="recurso-cta">
                        <div class="cta-container">
                            <h3>√önete gratis para acceder al directorio</h3>
                            <p>Acceso inmediato por email, sin contrase√±as</p>
                            
                            <div class="benefits-list" style="margin: 1.5rem 0;">
                                <p style="margin-bottom: 0.5rem;"><strong>¬øQu√© incluye el acceso?</strong></p>
                                <ul style="list-style: none; padding: 0;">
                                    <li style="margin: 0.5rem 0; padding-left: 1.5rem; position: relative;">
                                        <span style="position: absolute; left: 0; color: #22c55e;">‚úÖ</span>
                                        Directorio completo de proveedores sostenibles
                                    </li>
                                    <li style="margin: 0.5rem 0; padding-left: 1.5rem; position: relative;">
                                        <span style="position: absolute; left: 0; color: #22c55e;">‚úÖ</span>
                                        Informaci√≥n detallada: materiales, m√≠nimos, plazos
                                    </li>
                                    <li style="margin: 0.5rem 0; padding-left: 1.5rem; position: relative;">
                                        <span style="position: absolute; left: 0; color: #22c55e;">‚úÖ</span>
                                        Acceso v√°lido 60 d√≠as (se renueva autom√°ticamente cuando lo usas)
                                    </li>
                                </ul>
                            </div>

                            <!-- Embed de Tally -->
                            <div class="tally-form-container">
                                <iframe
                                  src="https://tally.so/embed/mDrJal?alignLeft=1&hideTitle=1&transparentBackground=1&resource_id=dir&source=web&utm_medium=gate<% if (q && q.utm_source) { %>&utm_source=<%= encodeURIComponent(q.utm_source) %><% } %><% if (q && q.utm_campaign) { %>&utm_campaign=<%= encodeURIComponent(q.utm_campaign) %><% } %><% if (q && q.utm_content) { %>&utm_content=<%= encodeURIComponent(q.utm_content) %><% } %><% if (q && q.page_url) { %>&page_url=<%= encodeURIComponent(q.page_url) %><% } %>"
                                  width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0" title="√önete a Oficios Circulares">
                                </iframe>
                            </div>

                            <!-- Informaci√≥n adicional -->
                            <div class="form-info">
                                <p><small>üîí Tus datos est√°n seguros. Solo los usamos para enviarte el enlace de acceso y contenido relacionado ocasionalmente.</small></p>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Contenido protegido: lo controla el script (token/cookie) -->
                <div id="dir-content" style="display:none;">
                    <header class="recurso-header">
                        <h1 class="recurso-title">Directorio de Proveedores</h1>
                        <p class="recurso-description">Bienvenido/a al directorio vivo de proveedores sostenibles. Tu acceso est√° activo.</p>
                    </header>
                    
                    <!-- TODO: aqu√≠ va el contenido del directorio real -->
                    <div class="recurso-cta">
                        <div class="cta-container">
                            <h3>üöß Directorio en construcci√≥n</h3>
                            <p>Estamos preparando una experiencia incre√≠ble para ti. Muy pronto tendr√°s acceso completo al directorio.</p>
                            <p><small>Mientras tanto, puedes explorar nuestros otros recursos.</small></p>
                            <a href="/recursos" class="btn btn-primary">Ver recursos disponibles</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<%- include('partials/footer') %>

  <script>
  (function () {
    const gate = document.getElementById('gate');
    const content = document.getElementById('dir-content');
    const VALIDATE_URL = "https://hook.eu2.make.com/1li6x48yx19frcc13566ai2wd3ia402c"; // Make Custom Webhook

    function show(el){ el && (el.style.display='block'); }
    function hide(el){ el && (el.style.display='none'); }
    function setMemberCookie(){
      // Cookie de sesi√≥n de miembro: 60 d√≠as
      document.cookie = "oc_member=1; Max-Age=5184000; Path=/; SameSite=Lax";
    }
    function hasMemberCookie(){
      return document.cookie.split(';').some(c => c.trim().startsWith('oc_member=1'));
    }

    const params = new URLSearchParams(location.search);
    const token = params.get('token');

    if (hasMemberCookie()) { show(content); hide(gate); return; }

    if (token) {
      fetch(VALIDATE_URL + "?token=" + encodeURIComponent(token), { method:"GET", credentials:"omit" })
        .then(r => r.json())
        .then(j => {
          if (j && j.ok) { setMemberCookie(); show(content); hide(gate); }
          else { show(gate); hide(content); }
        })
        .catch(() => { show(gate); hide(content); });
    } else {
      show(gate); hide(content);
    }
  })();
  </script>
</body>
</html>
